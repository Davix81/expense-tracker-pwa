<div class="dialog-header">
  <h2 mat-dialog-title>
    <mat-icon>{{ isEditMode ? 'edit' : 'add_circle' }}</mat-icon>
    {{ isEditMode ? 'Edita la despesa' : 'Nova despesa' }}
  </h2>
</div>

<mat-dialog-content>
  <app-notification-message 
    [message]="errorMessage" 
    type="error" 
    [show]="showErrorMessage">
  </app-notification-message>

  <form [formGroup]="expenseForm" class="expense-form">
    <!-- Row 1: Name and Category -->
    <div class="form-row">
      <mat-form-field appearance="outline">
        <mat-label>Nom</mat-label>
        <input matInput formControlName="name" placeholder="Factura llum" required>
        <mat-icon matPrefix>label</mat-icon>
        <mat-error *ngIf="expenseForm.get('name')?.invalid">Obligatori</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Categoria</mat-label>
        <mat-select formControlName="category" required>
          <mat-option *ngFor="let category of categories$ | async" [value]="category">
            {{ category }}
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>category</mat-icon>
        <mat-error *ngIf="expenseForm.get('category')?.invalid">Obligatori</mat-error>
      </mat-form-field>
    </div>

    <!-- Row 2: Description -->
    <div class="form-row full-width">
      <mat-form-field appearance="outline">
        <mat-label>Descripció</mat-label>
        <input matInput formControlName="description" placeholder="Descripció breu" required>
        <mat-icon matPrefix>description</mat-icon>
        <mat-error *ngIf="expenseForm.get('description')?.invalid">Obligatori</mat-error>
      </mat-form-field>
    </div>

    <!-- Row 3: Issuer and Bank -->
    <div class="form-row">
      <mat-form-field appearance="outline">
        <mat-label>Emissor</mat-label>
        <input matInput formControlName="issuer" placeholder="Endesa" required>
        <mat-icon matPrefix>business</mat-icon>
        <mat-error *ngIf="expenseForm.get('issuer')?.invalid">Obligatori</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Banc</mat-label>
        <input matInput formControlName="bank" placeholder="CaixaBank" required>
        <mat-icon matPrefix>account_balance</mat-icon>
        <mat-error *ngIf="expenseForm.get('bank')?.invalid">Obligatori</mat-error>
      </mat-form-field>
    </div>

    <!-- Row 4: Periodicity and Fraction -->
    <div class="form-row">
      <mat-form-field appearance="outline">
        <mat-label>Periodicitat</mat-label>
        <mat-select formControlName="periodicity" required>
          <mat-option *ngFor="let periodicity of periodicities" [value]="periodicity">
            {{ getPeriodicityLabel(periodicity) }}
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>event_repeat</mat-icon>
        <mat-error *ngIf="expenseForm.get('periodicity')?.invalid">Obligatori</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fracció</mat-label>
        <mat-select formControlName="fraction" required>
          <mat-option *ngFor="let fraction of fractions" [value]="fraction">
            {{ getFractionLabel(fraction) }}
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>splitscreen</mat-icon>
        <mat-error *ngIf="expenseForm.get('fraction')?.invalid">Obligatori</mat-error>
      </mat-form-field>
    </div>

    <!-- Row 5: Approximate Amount, Scheduled Date, and Tag -->
    <div class="form-row three-columns">
      <mat-form-field appearance="outline">
        <mat-label>Import aprox.</mat-label>
        <input matInput type="number" formControlName="approximateAmount" placeholder="0.00" required>
        <span matPrefix>€&nbsp;</span>
        <mat-error *ngIf="expenseForm.get('approximateAmount')?.invalid">Obligatori</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Data prevista</mat-label>
        <input matInput [matDatepicker]="scheduledPicker" formControlName="scheduledPaymentDate" required>
        <mat-datepicker-toggle matSuffix [for]="scheduledPicker"></mat-datepicker-toggle>
        <mat-datepicker #scheduledPicker></mat-datepicker>
        <mat-error *ngIf="expenseForm.get('scheduledPaymentDate')?.invalid">Obligatori</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Etiqueta</mat-label>
        <mat-select formControlName="tag">
          <mat-option [value]="''">Sense etiqueta</mat-option>
          <mat-option *ngFor="let tag of tags$ | async" [value]="tag">
            {{ tag }}
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>local_offer</mat-icon>
      </mat-form-field>
    </div>

    <!-- Divider -->
    <div class="divider">
      <span>Pagament Real {{ expenseForm.get('paymentStatus')?.value === 'PAID' ? '(Obligatori)' : '(Opcional)' }}</span>
    </div>

    <!-- Row 6: Actual Amount, Actual Date, and Status -->
    <div class="form-row three-columns">
      <mat-form-field appearance="outline">
        <mat-label>Import real</mat-label>
        <input matInput type="number" formControlName="actualAmount" placeholder="0.00">
        <span matPrefix>€&nbsp;</span>
        <mat-error *ngIf="expenseForm.get('actualAmount')?.hasError('required')">Obligatori per estat Pagat</mat-error>
        <mat-error *ngIf="expenseForm.get('actualAmount')?.hasError('min')">Ha de ser positiu</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Data real</mat-label>
        <input matInput [matDatepicker]="actualPicker" formControlName="actualPaymentDate">
        <mat-datepicker-toggle matSuffix [for]="actualPicker"></mat-datepicker-toggle>
        <mat-datepicker #actualPicker></mat-datepicker>
        <mat-error *ngIf="expenseForm.get('actualPaymentDate')?.hasError('required')">Obligatori per estat Pagat</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Estat</mat-label>
        <mat-select formControlName="paymentStatus" required>
          <mat-option *ngFor="let status of paymentStatuses" [value]="status">
            <span class="status-option" [class]="'status-' + status.toLowerCase()">
              {{ getStatusLabel(status) }}
            </span>
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>payment</mat-icon>
      </mat-form-field>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions>
  <button mat-button (click)="onCancel()" [disabled]="isSubmitting">
    <mat-icon>close</mat-icon>
    <span class="button-text">Cancel·la</span>
  </button>
  <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="isSubmitting || expenseForm.invalid">
    <mat-icon>{{ isEditMode ? 'save' : 'add' }}</mat-icon>
    <span class="button-text">{{ isSubmitting ? (isEditMode ? 'Guardant...' : 'Afegint...') : (isEditMode ? 'Guardar' : 'Afegir') }}</span>
  </button>
</mat-dialog-actions>
